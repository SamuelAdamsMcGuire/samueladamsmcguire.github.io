<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ startOnLoad: false, theme: 'dark' });

  async function renderMermaid() {
    const elements = document.querySelectorAll('.mermaid:not([data-processed])');
    for (const el of elements) {
      const id = 'mermaid-' + Math.random().toString(36).substr(2, 9);
      const { svg } = await mermaid.render(id, el.textContent);
      el.innerHTML = svg;
      el.setAttribute('data-processed', 'true');
    }
  }

  // Render on initial load
  await renderMermaid();

  // Re-render when navigating to a slide with unrendered mermaid
  if (typeof Reveal !== 'undefined') {
    Reveal.on('slidechanged', () => renderMermaid());
  } else {
    window.addEventListener('load', () => {
      if (typeof Reveal !== 'undefined') {
        Reveal.on('slidechanged', () => renderMermaid());
      }
    });
  }
</script>
